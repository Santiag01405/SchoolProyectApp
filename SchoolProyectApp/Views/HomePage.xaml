<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:SchoolProyectApp.ViewModels"
             xmlns:local="clr-namespace:SchoolProyectApp.Views"
             xmlns:models="clr-namespace:SchoolProyectApp.Models"
             x:Class="SchoolProyectApp.Views.HomePage"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:droid="clr-namespace:CommunityToolkit.Maui.PlatformConfiguration.AndroidSpecific;assembly=CommunityToolkit.Maui"
             droid:NavigationBar.Color="white"
             BackgroundColor="{x:Static vm:ThemeColors.PageBackgroundColor}"
             droid:NavigationBar.Style="LightContent"
             x:Name="ThisPage">

    <ContentPage.Behaviors>
        <toolkit:StatusBarBehavior StatusBarColor="{x:Static vm:ThemeColors.PrimaryColor}"
                                   StatusBarStyle="LightContent" />
    </ContentPage.Behaviors>

    <ContentPage.BindingContext>
        <vm:HomePageViewModel />
    </ContentPage.BindingContext>

    <AbsoluteLayout>

        <BoxView Color="{x:Static vm:ThemeColors.PrimaryColor}"
                 AbsoluteLayout.LayoutBounds="0,0,1,80"
                 AbsoluteLayout.LayoutFlags="WidthProportional" />

        <Image Source="Images/logo.png"
               AbsoluteLayout.LayoutBounds="0.5,0,170,90"
               AbsoluteLayout.LayoutFlags="PositionProportional"
               Aspect="AspectFit"
               BackgroundColor="Transparent" />

        <ContentView x:Name="MainContent"
                     AbsoluteLayout.LayoutBounds="0,110,1,0.85"
                     AbsoluteLayout.LayoutFlags="WidthProportional,HeightProportional">

            <Grid Padding="0" RowDefinitions="Auto,*,Auto">

                <Label Grid.Row="0"
                       Text="{Binding SchoolName}"
                       FontSize="20"
                       FontAttributes="Bold"
                       HorizontalOptions="Center"
                       TextColor="{x:Static vm:ThemeColors.SecondaryColor}"
                       Margin="0,10,0,5"/>

                <Label Grid.Row="0"
                       Text="{Binding CurrentLapsoName}"
                       FontSize="16"
                       FontAttributes="Italic"
                       TextColor="{x:Static vm:ThemeColors.PrimaryColor}"
                       HorizontalOptions="Center"
                       Margin="0,50,0,5"/>

                <Grid Grid.Row="1">

                    <ContentView IsVisible="{Binding IsNurseAndProfessor}">
                        <StackLayout Padding="20" Spacing="15">
                            <Label Text="Notificaciones Recientes"
                                   FontSize="22"
                                   FontAttributes="Bold"
                                   HorizontalOptions="Center"
                                   BackgroundColor="{x:Static vm:ThemeColors.PageBackgroundColor}"/>

                            <StackLayout HorizontalOptions="Center" VerticalOptions="CenterAndExpand"
                                         IsVisible="{Binding HasNotifications, Converter={StaticResource InverseBooleanConverter}}">
                                <Label Text="&#xf1f6;" FontFamily="FontAwesomeSolid" FontSize="100"
                                       TextColor="LightGray" HorizontalOptions="Center" Margin="0,40,0,20"/>
                                <Label Text="No hay notificaciones recientes" FontSize="18"
                                       HorizontalOptions="Center" TextColor="Gray"/>
                            </StackLayout>

                            <CollectionView ItemsSource="{Binding Notifications}" IsVisible="{Binding HasNotifications}">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate>
                                        <Border Stroke="#E0E0E0" StrokeThickness="1" Padding="15" Margin="0,0,0,10" BackgroundColor="White">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="10"/>
                                            </Border.StrokeShape>
                                            <!--<Border.Shadow>
                                                <Shadow Brush="#000" Opacity="0.1" Radius="10" Offset="5,5"/>
                                            </Border.Shadow>-->

                                            <Grid RowDefinitions="Auto,Auto,Auto" RowSpacing="5">
                                                <Label Grid.Row="0" Text="{Binding Title}" FontSize="16" FontAttributes="Bold" BackgroundColor="{x:Static vm:ThemeColors.PageBackgroundColor}"/>
                                                <Label Grid.Row="1" Text="{Binding Content}" FontSize="14" TextColor="{Binding TextColor}"/>
                                                <Label Grid.Row="2" Text="{Binding Date, StringFormat='{0:dd/MM/yyyy HH:mm}'}" FontSize="12" TextColor="Gray" HorizontalOptions="End"/>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>

                            <Button Text="Ver todas las notificaciones" Command="{Binding NotificationCommand}" Margin="20,10"/>
                        </StackLayout>
                    </ContentView>

                    <ContentView IsVisible="{Binding IsStudent}">
                        <ScrollView>
                            <VerticalStackLayout Padding="20" Spacing="15">
                                <Label Text="{Binding Today}" FontSize="16" TextColor="DarkGray" HorizontalOptions="Center"/>

                                <Border Stroke="#E0E0E0" StrokeThickness="1" Padding="15">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="10"/>
                                    </Border.StrokeShape>
                                    <StackLayout>
                                        <Label Text="Promedio General"
                                               FontSize="18"
                                               FontAttributes="Bold"
                                               BackgroundColor="{x:Static vm:ThemeColors.PageBackgroundColor}"
                                               HorizontalOptions="Center"/>
                                        <Label Text="{Binding StudentOverallAverage}"
                                               FontSize="32"
                                               FontAttributes="Bold"
                                               TextColor="Green"
                                               HorizontalOptions="Center"
                                               Margin="0,10"/>
                                    </StackLayout>
                                </Border>

                                <Border Stroke="#E0E0E0" StrokeThickness="1" Padding="15">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="10"/>
                                    </Border.StrokeShape>
                                    <StackLayout>
                                        <Label Text="Clases de hoy" FontSize="18" FontAttributes="Bold" BackgroundColor="{x:Static vm:ThemeColors.PageBackgroundColor}"/>
                                        <StackLayout BindableLayout.ItemsSource="{Binding TodaysClasses}" Margin="0,10,0,0">
                                            <BindableLayout.ItemTemplate>
                                                <DataTemplate>
                                                    <Label Text="{Binding Name}" FontSize="16" Padding="10,5"/>
                                                </DataTemplate>
                                            </BindableLayout.ItemTemplate>
                                        </StackLayout>
                                    </StackLayout>
                                </Border>

                                <Border Stroke="#E0E0E0" StrokeThickness="1" Padding="15">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="10"/>
                                    </Border.StrokeShape>
                                    <StackLayout Spacing="10">
                                        <Label Text="Próxima Evaluación" FontSize="18" FontAttributes="Bold" BackgroundColor="{x:Static vm:ThemeColors.PageBackgroundColor}"/>
                                        <StackLayout BindableLayout.ItemsSource="{Binding UpcomingEvaluations}">
                                            <BindableLayout.ItemTemplate>
                                                <DataTemplate>
                                                    <StackLayout>
                                                        <Label Text="{Binding Title}" FontSize="16" FontAttributes="Bold" />
                                                        <Label Text="{Binding Description}" FontSize="14" />
                                                        <Label Text="{Binding Date, StringFormat='Fecha: {0:dd/MM/yyyy HH:mm}'}" FontSize="12" TextColor="Gray" />
                                                        <BoxView HeightRequest="1" Color="#E0E0E0" Margin="0,5"/>
                                                    </StackLayout>
                                                </DataTemplate>
                                            </BindableLayout.ItemTemplate>
                                        </StackLayout>
                                    </StackLayout>
                                </Border>
                            </VerticalStackLayout>
                        </ScrollView>
                    </ContentView>

                    <ContentView IsVisible="{Binding IsParent}">
                        <ScrollView>
                            <VerticalStackLayout Padding="20" Spacing="15">
                                <Label Text="Mis Hijos" FontSize="22" FontAttributes="Bold" BackgroundColor="{x:Static vm:ThemeColors.PageBackgroundColor}" HorizontalOptions="Center" />

                                <StackLayout BindableLayout.ItemsSource="{Binding Hijos}">
                                    <BindableLayout.ItemTemplate>
                                        <DataTemplate x:DataType="models:Child">
                                            <Border Stroke="#E0E0E0" StrokeThickness="1" Padding="15" Margin="0,5">
                                                <Border.StrokeShape>
                                                    <RoundRectangle CornerRadius="10"/>
                                                </Border.StrokeShape>
                                                <!--<Border.Shadow>
                                                    <Shadow Brush="#000" Opacity="0.1" Radius="10" Offset="5,5"/>
                                                </Border.Shadow>-->
                                                <Border.GestureRecognizers>
                                                    <TapGestureRecognizer Command="{Binding BindingContext.SelectChildCommand, Source={x:Reference ThisPage}}"
                                                                          CommandParameter="{Binding .}" />
                                                </Border.GestureRecognizers>
                                                <Label Text="{Binding StudentName}" FontSize="18" FontAttributes="Bold" TextColor="{x:Static vm:ThemeColors.PrimaryColor}"/>
                                            </Border>
                                        </DataTemplate>
                                    </BindableLayout.ItemTemplate>
                                </StackLayout>

                                <BoxView HeightRequest="1" Color="LightGray" Margin="0,15,0,0"/>

                                <Label Text="Notificaciones Recientes" FontSize="22" FontAttributes="Bold" BackgroundColor="{x:Static vm:ThemeColors.PageBackgroundColor}" HorizontalOptions="Center" />

                                <StackLayout HorizontalOptions="Center" VerticalOptions="Center"
                                             IsVisible="{Binding HasNotifications, Converter={StaticResource InverseBooleanConverter}}">
                                    <Label Text="&#xf1f6;" FontFamily="FontAwesomeSolid" FontSize="100" TextColor="LightGray" HorizontalOptions="Center" Margin="0,40,0,20"/>
                                    <Label Text="No hay notificaciones recientes" FontSize="18" HorizontalOptions="Center" TextColor="Gray"/>
                                </StackLayout>

                                <StackLayout BindableLayout.ItemsSource="{Binding Notifications}" IsVisible="{Binding HasNotifications}">
                                    <BindableLayout.ItemTemplate>
                                        <DataTemplate>
                                            <Border Stroke="#E0E0E0" StrokeThickness="1" Padding="15" Margin="0,0,0,10">
                                                <Border.StrokeShape>
                                                    <RoundRectangle CornerRadius="10"/>
                                                </Border.StrokeShape>
                                                <Border.Shadow>
                                                    <Shadow Brush="#000" Opacity="0.1" Radius="10" Offset="5,5"/>
                                                </Border.Shadow>
                                                <Grid RowDefinitions="Auto,Auto,Auto" RowSpacing="5">
                                                    <Label Grid.Row="0" Text="{Binding Title}" FontSize="16" FontAttributes="Bold" BackgroundColor="{x:Static vm:ThemeColors.PageBackgroundColor}"/>
                                                    <Label Grid.Row="1" Text="{Binding Content}" FontSize="14" TextColor="{Binding TextColor}"/>
                                                    <Label Grid.Row="2" Text="{Binding Date, StringFormat='{0:dd/MM/yyyy HH:mm}'}" FontSize="12" TextColor="Gray" HorizontalOptions="End"/>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </BindableLayout.ItemTemplate>
                                </StackLayout>

                                <Button Text="Ver todas las notificaciones" Command="{Binding NotificationCommand}" Margin="20,10"/>
                            </VerticalStackLayout>
                        </ScrollView>
                    </ContentView>

                </Grid>

                <Grid Grid.Row="2" BackgroundColor="{x:Static vm:ThemeColors.PageBackgroundColor}" Padding="10">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>

                    <StackLayout Grid.Column="0" HorizontalOptions="Center">
                        <Button Text="&#xf015;" FontFamily="FontAwesomeSolid" FontSize="24"
                                TextColor="{x:Static vm:ThemeColors.PrimaryColor}" BackgroundColor="{x:Static vm:ThemeColors.PageBackgroundColor}" Command="{Binding HomeCommand}" />
                        <Label Text="Inicio" FontSize="10" HorizontalOptions="Center" />
                    </StackLayout>

                    <StackLayout Grid.Column="1" HorizontalOptions="Center">
                        <Button Text="&#xf007;" FontFamily="FontAwesomeSolid" FontSize="24"
                                TextColor="{x:Static vm:ThemeColors.PrimaryColor}" BackgroundColor="{x:Static vm:ThemeColors.PageBackgroundColor}" Command="{Binding FirstProfileCommand}" />
                        <Label Text="Perfil" FontSize="10" HorizontalOptions="Center" />
                    </StackLayout>

                    <StackLayout Grid.Column="2" HorizontalOptions="Center">
                        <Button Text="&#xf0c9;" FontFamily="FontAwesomeSolid" FontSize="24"
                                TextColor="{x:Static vm:ThemeColors.PrimaryColor}"
                                Clicked="MenuButton_Clicked" />
                        <Label Text="Menú" FontSize="10" HorizontalOptions="Center" />
                    </StackLayout>
                </Grid>
            </Grid>
        </ContentView>

        <ContentView x:Name="SideMenu"
                     WidthRequest="260"
                     BackgroundColor="{x:Static vm:ThemeColors.PrimaryColor}"
                     IsVisible="False"
                     TranslationX="-260"
                     AbsoluteLayout.LayoutBounds="0,0,260,1"
                     AbsoluteLayout.LayoutFlags="PositionProportional,HeightProportional">
            <local:MenuPage />
        </ContentView>
    </AbsoluteLayout>
</ContentPage>